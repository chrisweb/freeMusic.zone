#cloud-config (mongodb)
#freeMusic.zone

# Upgrade the instance on first boot
package_upgrade: true

# add the 10gen repository to /etc/yum.repos.d
yum_repos:
  10gen:
    baseurl: http://downloads-distro.mongodb.org/repo/redhat/os/x86_64
    enabled: true
    failovermethod: priority
    gpgcheck: false
    name: 10gen repository for mongodb
    priority: 20

# install packages
packages:
  - mongo-10gen
  - mongo-10gen-server

# create groups
groups:
  - mongodb-group

# create user
users:
  - default
  - name: mongodb-user
    gecos: MongoDB User
    system: true
    groups: mongodb-group

runcmd:
 # configure mongodb
 # TODO: disable auth (is default), then checkout the script
 # (freeMusic.zone/cloud/script/mongodb-users.js) from github that
 # will setup the users, edit the file and set the passwords you want, run that
 # script to create the admin user as well as some users that will access the
 # database with the following command:
 # mongo mongodb-users.js
 # then enable auth and restart the server
 #- [ sed, -i, "s/# auth = true/auth = true/g", /etc/mongodb.conf ]
 # TODO: is there a better way to update the configuration file???
 - [ sed, -i, "s/httpinterface = true/httpinterface = false/g", /etc/mongodb.conf ]
 - [ sed, -i, "s/# noscripting = true/noscripting = true/g", /etc/mongodb.conf ]
 - [ sed, -i, "s/# notablescan = true/notablescan = true/g", /etc/mongodb.conf ]
 # restart mongodb
 [ restart, mongodb ]
 
 # TODO: instead of having just one mongodb database if would be nice to have
 # a replica set of multiple databases
 # http://docs.mongodb.org/manual/replication/

final_message: "The mongodb server is finally up, after $UPTIME seconds"

output: {all: '| tee -a /var/log/cloud-init-output.log'}

# vim:syntax=yaml expandtab